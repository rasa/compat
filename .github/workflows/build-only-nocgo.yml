---
# yaml-language-server: $schema https://json.schemastore.org/github-workflow.json

name: build-only-nocgo

on: # yamllint disable-line rule:truthy
  workflow_call: # Required so this workflow can be called from another workflow
    inputs:
      cgo:
        type: string
        default: "0"
      goarches:
        type: string
        default: default
      verbose_testing:
        type: string
        default: "false"
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab
    inputs:
      # checkov:skip=CKV_GHA_7:The build output cannot be affected by user parameters...
      cgo:
        type: choice
        default: "0"
        options:
          - "0"
          - "1"
      # checkov:skip=CKV_GHA_7:The build output cannot be affected by user parameters...
      goarches:
        description: "Build on the default GOARCH, or all GOARCHes for the OS"
        type: choice
        options:
          - default
          - all
        default: default
      # checkov:skip=CKV_GHA_7:The build output cannot be affected by user parameters...
      verbose_testing:
        description: "Test with -v options."
        type: choice
        options:
          - "false"
          - "true"
        default: "false"

env:
  goarches: ${{ inputs.goarches }}
  verbose_testing: ${{ inputs.verbose_testing }}

jobs:
  build-only-nocgo:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        check-latest: true

    - run: printf '::notice ::%s\n' "$(go version)"

    - name: go build (all targets but android and ios)
      env:
        CGO_ENABLED: ${{ inputs.cgo }}
      run: |
        # go build (all targets but android and ios)
        printf 'goarches=%s\n' "${{ inputs.goarches }}"
        mapfile -t targets < <(go tool dist list | grep -E -v '(android|ios)')
        set +e
        fails=0
        builds=0
        declare -A seen
        for target in "${targets[@]}"; do
          export GOOS="${target%%/*}"
          if [[ -v seen["${GOOS}"] ]]; then
            test "${{ inputs.goarches }}" == "all" || continue
          fi
          export GOARCH="${target#*/}"
          seen["${GOOS}"]=1
          ((builds++))
          echo "Build ${builds}: ${target}"
          if ! go build .; then
            echo "::warning ::Failed to build ${target}"
            ((fails++))
          fi
        done
        if ((fails>0)); then
          echo "::warning ::${fails} of ${builds} builds failed"
        fi
        exit "${fails}"

    - run: |
        # go test .

        printf "verbose_testing=%s\n" "${verbose_testing:-}"
        printf "inputs.verbose_testing=%s\n" "${{ inputs.verbose_testing }}"

        TEST_OPTS=()
        if [[ "${{ inputs.verbose_testing }}" == "true" ]]; then
          TEST_OPTS+=(-v)
        fi

        go test "${TEST_OPTS[@]}" .
