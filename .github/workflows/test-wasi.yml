name: test-wasi

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-wasi:
    name: test-wasi
    runs-on: ubuntu-latest
    defaults:
      run:
        # Docs: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsshell
        shell: bash --noprofile --norc -e -u -o pipefail -v -x {0}
    steps:
      - uses: actions/checkout@v4

      - run: |
          curl -LO https://wasmtime.dev/install.sh
          chmod +x install.sh

      - uses: ludeeus/action-shellcheck@master
        continue-on-error: true

      - run: . ./install.sh

      - run: ./install.sh

      - run: |
          ls -lR ~/.wasmtime
          echo "${HOME}/.wasmtime/bin" >>"${GITHUB_PATH}"

      - run: |
          printf "PATH=%s\n" "${PATH}"
          command -v wasmtime

      - run: |
          curl -LO https://github.com/tinygo-org/tinygo/releases/download/v0.38.0/tinygo_0.38.0_amd64.deb
          sudo dpkg -i tinygo_0.38.0_amd64.deb

      - run: |
          export PATH="${HOME}/.wasmtime/bin:${PATH}"
          tinygo test -v -tags tinygo -target=wasi -o main.test.wasm .
        env:
          GOOS: wasip1
          GOARCH: wasm

      - run: |
          export PATH="${HOME}/.wasmtime/bin:${PATH}"
          wasmtime run main.test.wasm
